{% extends "base.html" %}
{% load url from future %}
{% load staticfiles %}
{% block title %}
Admissions database - {{ team.college.name }} schedule editor
{% endblock %}
{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href='{% static "js/DataTables-1.10.2/media/css/jquery.dataTables.min.css" %}'>
<link rel="stylesheet" href='{% static "js/DataTables-1.10.2/extensions/ColVis/css/dataTables.colVis.min.css" %}'>
<link rel="stylesheet" href='{% static "js/DataTables-1.10.2/extensions/TableTools/css/dataTables.tableTools.min.css" %}'>
<link rel="stylesheet" type="text/css" href='{% static "js/datetimepicker-master/jquery.datetimepicker.css" %}'/ >
<script src='{% static "js/jquery-1.11.1.min.js" %}'></script>
<!--script src='{% static "js/datetimepicker-master/jquery.js" %}'></script-->
<script src='{% static "js/DataTables-1.10.2/media/js/jquery.dataTables.min.js" %}'></script>
<script src='{% static "js/DataTables-1.10.2/extensions/ColVis/js/dataTables.colVis.min.js" %}'></script>
<script src='{% static "js/DataTables-1.10.2/extensions/TableTools/js/dataTables.tableTools.min.js" %}'></script>
<script src='{% static "js/jquery-cookie-1.4.1/jquery.cookie.js" %}'></script>
<script src='{% static "js/datetimepicker-master/build/jquery.datetimepicker.full.min.js" %}'></script>
<style>
table#teamspec { font-size: 16px; text-align: left }

td.comments-detail {
  color: blue;
  cursor: pointer;
}

.comments { text-align: left }

input.change-duration { width: 3em }

</style>
{% endblock %}
{% block content %}
<h2>Schedule editor for {{ team.college.name }} ({{ team.college.adss_code }})</h2>

<p>
<table id="teamspec" cellpadding="3">
<tr>
  <td>Team:</td>
  <td>{{ team.names }}</td>
</tr>
<tr>
  <td>Location:</td>
  <td>{{ team.location }}</td>
</tr>
<tr>
  <td>Notes:</td>
  <td>{{ team.notes }}</td>
</tr>
</table>
</p>

<p>
<table cellspacing="0" cellpadding="3" border="1">
<tr>
  <th>Schedule Defaults</th>
  <th>(minutes)</th>
  <th>Candidate Actions</th>
  <th>Course Actions</th>
</tr>
<tr>
  <td>Interview duration</td>
  <td><input type="number" name="interviewduration" style="width:5em"></td>
  <td><button type='button' id='rotatebutton'>Rotate selected</button</td>
  <td><button type='button' id='physicsbutton'>Physics interviews</button></td>
</tr>
<tr>
  <td>Break duration</td>
  <td><input type="number" name="breakduration" style="width:5em"></td>
  <td><button type='button' id='shufflebutton'>Shuffle selected</button</td>
  <td><button type='button' id='philosophybutton'>Philosophy interviews</button></td>
</tr>
<tr>
  <td><button type='button' id='recalcbutton'>Recalculate</button></td>
  <td><button type='button' id='clearbutton'>Clear</button></td>
  <td><button type='button' id='allbutton'>Select all</button</td>
  <td><button type='button' id='reversebutton'>Reverse selection</button></td>
</tr>
</table>
<td><button type='button' id='savebutton' class='statebutton' disabled=true>Save schedule</button></td>
</p>

<p>To leave schedule unchanged, leave this page without saving.</p>

<p>
<table id="slots" class="display compact" cellspacing="0" cellpadding="0" width="100%">
<thead>
  <tr>
    <th colspan="3" align="left">Change</th>
    <th colspan="3" align="left">Current schedule</th>
    <th colspan="6" align="left">Candidate</th>
    <th></th>
  </tr>
  <tr>
    <th>Date</th>
    <th>Start</th>
    <th>Duration</th>
    <th>Date</th>
    <th>Start</th>
    <th>End time</th>
    <th>Type</th>
    <th>Subject</th>
    <th>Course</th>
    <th>Name</th>
    <th>Notes</th>
    <th>Other interviews</th>
    <th>Index</th>
  </tr>
</thead>
<tfoot>
  <tr>
    <th>Date</th>
    <th>Start</th>
    <th>Duration</th>
    <th>Date</th>
    <th>Start</th>
    <th>End time</th>
    <th>Type</th>
    <th>Subject</th>
    <th>Course</th>
    <th>Name</th>
    <th>Notes</th>
    <th>Other interviews</th>
    <th>Index</th>
  </tr>
</tfoot>
</table>
</p>

<p>
<a href="{% url 'admissions:view_schedule' college_code=team.college.adss_code|lower %}">[Return to college interview schedule]</a>
</p>
{% endblock %}

{% block scripts %}
<script>
// template entries:  team, students, slots
var students = {};
{% for student in students %}
students[{{ student.pk }}] = {
  "n": "{{ student.info.surname }}, {{ student.info.forenames }}",
  "course": "{{ student.course_type }}",
  "other": [],
  "spec": "{{ student.info.has_special_needs }}",
  "dcode": "{{ student.info.disability_code }}",
  "dis": "{{ student.info.disability_notes }}",
  "comments": [],
};
{% endfor %}

{% for comment in comments %}
students[{{ comment.candidate.pk }}]['comments'].push(
    { "who": "{{ comment.commenter.username }}", "t": "{{ comment.text }}" })
{% endfor %}

{% for slot in slots %}
  {% if slot.team.pk == team.pk %}
students[{{ slot.candidate.pk }}]["s"] = {
    "subject": "{{ slot.subject }}",
    "mode": "{{ slot.mode }}",
    "datetime": {{ slot.time|date:"U" }},
    "duration": {{ slot.length }},
  };
  {% else %}
students[{{ slot.candidate.pk }}]["other"].push({
    "tpk": {{ slot.team.pk }},
    "tcol": "{{ slot.team.college.adss_code }}",
    "mode": "{{ slot.mode }}",
    "datetime": {{ slot.time|date:"U" }},
  });
  {% endif %}
{% endfor %}

var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

function twoDigit(n) {
  var s = (n < 10 ? "0" : "");
  return s + n;
}

function formatDate(d) {
  return twoDigit(d.getDate()) + " " + months[d.getMonth()];
}

function formatTime(d) {
  //return d.toLocaleTimeString();
  return twoDigit(d.getHours()) + ":" + twoDigit(d.getMinutes());
}

function format_comments(pk, jrow) {
  var s = [];
  var d = students[pk];
  var c = d.comments;
  s.push('<p><ul class="comments">');
  s.push("<li><b>UCAS disability information</b><br>(" + d.dcode + ") " + d.dis);
  for (var i = 0; i < c.length; ++i) {
    s.push("<li><b>" + c[i].who + "</b><br>" +
           c[i].t.replace('&#10;','<br>').replace('\n','<br>').replace('\r',''));
  }
  s.push('</ul></p>');
  return s.join('');
}

function render_change_start(data, type, row, meta) {
  if (type == "display") {
    return '<input id="datetimepicker' + row[12] + '" type="text">';
  } else {
    return data;
  }
}

function render_change_duration(data, type, row, meta) {
  if (type == "display") {
    return '<input type="number" class="change-duration">';
  } else {
    return data;
  }
}

function render_start(data, type, row, meta) {
  if (type == "display") {
    var a = new Date(data * 1000);
    return formatDate(a) + " " + formatTime(a);
  } else {
    return data;
  }
}

function render_end(data, type, row, meta) {
  if (type == "display") {
    var a = new Date(data * 1000);
    return formatTime(a);
  } else {
    return data;
  }
}

function render_mode(data, type, row, meta) {
  if (type === "display") {
    var td = [];
    td.push('<select onchange="enable_save()">');
    td.push('<option value="0">no interview</option>');
    td.push('<option value="L">local</option>');
    td.push('<option value="R">remote</option>');
    td.push('</select>');
    return td.join('');
  } else {
    return data;
  }
}

function render_subject(data, type, row, meta) {
  if (type === "display") {
    var td = [];
    td.push('<select onchange="enable_save()">');
    td.push('<option value="1">physics</option>');
    td.push('<option value="2">philosophy</option>');
    td.push('</select>');
    return td.join('');
  } else {
    return data;
  }
}

function enable_save() {
  $('.statebutton').removeAttr('disabled');
}

function disable_save() {
  $('.statebutton').attr('disabled','disabled');
}

var dataset = [];
$.each(students, function(pk, v) {
  var fields = [];
  fields[0] = ""; // date selector
  fields[1] = ""; // start time selector
  fields[2] = ""; // duration selector
  fields[3] = ""; // empty date
  fields[4] = ""; // empty start time
  fields[5] = ""; // empty end time
  if (v['s'] != undefined) {
    var a = new Date(v.s.datetime * 1000);
    var b = new Date((v.s.datetime + v.s.duration*60) * 1000);
    //fields[3] = formatDate(a);
    //fields[4] = formatTime(a);
    //fields[5] = formatTime(b);
    fields[4] = v.s.datetime;
    fields[5] = v.s.datetime + v.s.duration*60;
  }
  fields[6] = v.s.mode; // should be a selector
  fields[7] = v.s.subject; // should be a selector
  fields[8] = v.course;
  fields[9] = v.n;
  fields[10] = v.dcode == 'A' && v.comments.length == 0 ? '' : 'notes'; // disability or notes
  // other interviews in v.other
  var s = [];
  for (var i = 0; i < v.other.length; ++i) {
    var u = v.other[i];
    var a = new Date(u.datetime * 1000);
    s.push((u.mode != "local" ? "("+u.mode+") " : " ") +
           u.tcol + " " + formatDate(a) + " " + formatTime(a));
  }
  fields[11] = s.join('; ');
  fields[12] = pk;
  //console.log(fields);
  dataset.push(fields);
});
//console.log(dataset);

$(document).ready(function() {

  // dom:  T for TableTools, and C... for ColVis
  var spec = {
    dom: 'T<"clear">lfrtip', // add an R to use colReorder
    data: dataset,
    columns: [
      { name: "changedate", visible: false }, // spare
      { name: "changestart", "class": "datetimepickers", "render": render_change_start },
      { name: "changeduration", "render": render_change_duration },
      { name: "date", visible: false }, // spare
      { name: "start", "render": render_start },
      { name: "end", "render": render_end },
      { name: "mode", "class": "mode-selector", "render": render_mode },
      { name: "subject", "class": "subject-selector", "render": render_subject },
      { name: "course" },
      { name: "name" },
      { name: "notes", "class": "comments-detail" },
      { name: "other" },
      { name: "pk", visible: false },
    ],
    "pageLength": 50,
    "statesave": true,
    "tableTools": {
      "aButtons": [
        "copy",
        "csv",
        {
          "sExtends": "pdf",
          "sPdfOrientation": "portrait"
        },
        "print"
      ],
      "sSwfPath": '{% static "js/DataTables-1.10.2/extensions/TableTools/swf/copy_csv_xls_pdf.swf" %}'
    }
  };
  table = $('#slots').DataTable(spec);

  $('#slots tbody').on('click', 'td.comments-detail', function() {
    var tr = $(this).closest('tr');
    var row = table.row(tr);
    if (row.child.isShown()) {
      row.child.hide();
      tr.removeClass('shown-comments');
    } else {
      var child = row.child(format_comments(row.data()[12], row.index()) );
      child.show();
      tr.addClass('shown-comments');
    }
  });

  // insert initial changeable states
  table.$('.mode-selector').each(function(i, e) {
    var tr = $(e).closest('tr');
    var row = table.row(tr);
    var pk = row.data()[12];
    //console.log("Candidate " + pk + " mode " + students[pk].s.mode);
    if (students[pk] == undefined) {
      $("select", e).val('0');
      //console.log("no such pk");
    } else {
      if ('s' in students[pk]) {
        $("select", e).val(students[pk].s.mode == 'local' ? 'L' : 'R');
      } else {
        //console.log("no interview");
      }
    }
  });

  table.$('.subject-selector').each(function(i, e) {
    var tr = $(e).closest('tr');
    var row = table.row(tr);
    var pk = row.data()[12];
    if (students[pk] == undefined) {
      $("select", e).val('1');
    } else {
      if ('s' in students[pk]) {
        $("select", e).val(students[pk].s.subject == 'physics' ? '1' : '2');
      }
    }
    // also initialize datetimepickers
    var nm = "#datetimepicker" + pk;
    $(nm).datetimepicker({
      minDate: "2015/12/01",
      maxDate: "2015/12/17",
      startDate: "2015/12/14",
      defaultTime: "14:00"
    });
  });

  disable_save();

});
</script>
{% endblock %}
